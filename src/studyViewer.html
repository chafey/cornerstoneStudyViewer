<!DOCTYPE HTML>
<html>
<head>
    <TITLE>Loading...</TITLE>
    <!-- support for mobile touch devices -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1, minimal-ui">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/cornerstone.min.css" rel="stylesheet">
    <link href="css/studyViewer.css" rel="stylesheet">
</head>
<style>

</style>
<body>
<div id="header" style="position:fixed;width:100%;height:30px;">
    <div id="container">
        <div id="left" style="">
            <span class="header-item" href="#" id="logo">DICOM Study Viewer</span>
        </div>
        <div id="right" class="">
            <a id="help" href="#" class="header-item ">Help</a>
            <a id="about" href="#" class="header-item ">About</a>
        </div>
        <div id="center">
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="WW/WC"><span class="fa fa-sun-o"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Invert"><span class="fa fa-adjust"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Zoom"><span class="fa fa-search"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Pan"><span class="fa fa-arrows"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Stack Scroll"><span class="fa fa-bars"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Length Measurement"><span class="fa fa-arrows-v"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Angle Measurement"><span class="fa fa-angle-left"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Pixel Probe"><span class="fa fa-dot-circle-o"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Elliptical ROI"><span class="fa fa-circle-o"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Rectangle ROI"><span class="fa fa-square-o"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Play Clip"><span class="fa fa-play"></span></button>
                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Stop Clip"><span class="fa fa-stop"></span></button>
            </div>
        </div>
    </div>
</div>


<div id="studyContainer" class="studyContainer" style="">
    <div id="viewer">
        <div id="viewer-inner">
            <div class="imageViewer">
                <div class="viewportWrapper" style="width:100%;height:100%;position:relative;color: white;display:inline-block;background-color:black;"
                     oncontextmenu="return false"
                     class='cornerstone-enabled-image'
                     unselectable='on'
                     onselectstart='return false;'
                     onmousedown='return false;'>
                    <div class="viewport">
                        <div id="loadingMessage">
                            Loading study, please wait...
                        </div>
                    </div>
                    <div class="overlay" style="top:0px; left:0px">
                        <div class="overlayText">Patient ID</div>
                        <div class="overlayText">Patient Name</div>
                        <div class="overlayText">Accession #</div>
                        <div class="overlayText">Study Description</div>
                        <div class="overlayText">Study Date/Time</div>
                    </div>
                    <div class="overlay" style="top:0px; right:0px">
                        <div class="overlayText">Series Description</div>
                        <div class="overlayText">Series #</div>
                        <div class="overlayText">Protocol</div>
                        <div class="overlayText">Body Part</div>
                    </div>

                    <div class="overlay" style="bottom:0px; left:0px">
                        <div class="fps overlayText">FPS:</div>
                        <div class="renderTime overlayText">Render Time:</div>
                        <div class="seriesAndInstanceNum overlayText">Se:1 Im: 1</div>
                        <div class="currentImageAndTotalImages overlayText">Image #:</div>
                    </div>
                    <div class="overlay" style="bottom:0px; right:0px">
                        <div class="overlayText">Zoom:</div>
                        <div class="overlayText">WW/WC:</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div id="thumbnailSelector">
        <div id="thumbnails" class="list-group">
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Help</h4>
            </div>
            <div class="modal-body">
                <ol>
                    <li>Interact with the image using your mouse: left click drag - ww/wl, middle click drag - pan, right click drag - zoom, mouse wheel - scroll through stack</li>
                    <li>Select another series to display by left click the series list on the left</li>
                    <li>Select another tool to use with the left mouse button by selecting the tool button</li>
                </ol>
                <br>
                This viewer requires a HTLM5 browser, Google Chrome is recommended.  IE 11 is not yet supported.
                <br>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">About</h4>
            </div>
            <div class="modal-body">
                <br>
                This viewer is based on the <a href="https://github.com/chafey/cornerstone" target="_blank">Cornerstone</a> open source project.  All 2D image rendering is done on the client side
                side using HTML5 and JavaScript.  DICOM P10 Instances are retrieved via HTTP, parsed and displayed by the viewer.
                <br>
                <br>
                This viewer solution is distributed and supported by <a href="http://www.lury.net" target="_blank">Lury</a>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<div>
    <script src="js/jquery.min.js"></script>

    <script src="js/jquery.hammer-full.js"></script>


    <script src="js/bootstrap.min.js" ></script>

    <!-- include the cornerstone library -->
    <script src="js/cornerstone.min.js"></script>

    <!-- include the cornerstone library -->
    <script src="js/cornerstoneMath.min.js"></script>

    <!-- include the cornerstone tools library -->
    <script src="js/cornerstoneTools.min.js"></script>

    <!-- include the cornerstoneWADOImageLoader library -->
    <script src="js/cornerstoneWADOImageLoader.min.js"></script>

    <!-- include the dicomParser library -->
    <script src="js/dicomParser.min.js"></script>

    <script src="js/imageViewer.js"></script>
    <script src="js/studyParser.js"></script>
    <script src="js/normalizedStudyParser.js"></script>
    <script src="js/thumbnails.js"></script>

</div>


<script>

    $("#help").click(function() {
        $("#helpModal").modal();
    });

    $("#about").click(function() {
        $("#aboutModal").modal();
    });


    var studyId =  location.search.split('studyId=')[1];

    var start = new Date().getTime();

    $.getJSON('/studies/' + studyId + '/metadata/normalizedStudy', function(data) {
        var stop = new Date().getTime();
        console.log("normalized study took" + (stop - start) + " ms");
        var stacks = parseNormalizedStudy(data);

        $('#loadingMessage').remove();

        $("TITLE").text(data.SharedTags.x00100010);

        var context = {
            study: data,
            stacks: stacks,
            viewports: [
                {
                    element: undefined,
                    stackIndex: 0
                }
            ]
        }

        initializeViewportWithStack(context, 0, 0);
        loadThumbnails(context);
    })
    .error(function()
    {
        $('#loadingMessage').text("Error loading study");

    });

</script>

</body>
</html>